Водоводну мрежу можемо посматрати као стабло са кореном у чвору у ком се налази бојлер (чвор $1$).  На самом почетку, вода у свим цевима (тј. свим гранама стабла) је ледена. У току извршавања упита маркираћемо оне гране у којима вода постане топла. Сада сваки упит можемо формулисати као одговор на питање *Колико има немаркираних грана на путу од корена до чвора $x_i$?* Наравно, на почетку ниједна грана није маркирана.

Најједноставнији начин да одговоримо на упит је да обиђемо све гране од $x_i$ до корена, избројимо немаркиране, а затим их маркирамо. Овај приступ у најнеповољнијем случају обилази цело стабло при сваком упиту па је временска сложеност $O(MN)$. 

Кључна опсервација која нас доводи до бољег решења је да се сваки пут од корена до неког чвора дели на низ ($0$ или више) маркираних грана, а затим низ ($0$ или више) немаркираних грана. Другим речима, сви маркирани чворови на неком таквом путу чине префикс тог пута. Ово се лако доказује тако што приметимо да је свака маркирана грана постала маркирана при тражењу одговара на неки упит. Самим тим, све гране од ње до корена су такође маркиране у истом упиту. Имајући ово својство у виду, довољно је при сваком упиту обилазити само гране од $x_i$ до прве маркиране гране на путу до корена. Све гране на остатку пута су сигурно већ маркиране. 

Ово решење, иако за неке *незгодне* упите може обићи много грана, у току целог извршавања програма обиђе сваку грану највише једном (у тренутку када бива маркирана), па је укупна временска сложеност $O(N+M)$, што је у овом случају оптимално.

## Смернице за алгоритам

Са стране имплементације, решење се дели на два дела: припрему стабла и одговарање на упите. Припрема стабла се своди на чување родитељског чвора за сваки чвор, што након учитавања грана можемо урадити простом графовском претрагом (*DFS*/*BFS*). При сваком упиту долазимо до одговора праћењем низа родитељских чворова почевши од чвора $x_i$, притом вршећи маркирање свих посећених чворова.
