Размислимо прво како бисмо решили задатак у случају да није дата матрица већ низ вредности и да нема измена низа, па ћемо ово решење уопштити. Јасно је да се намеће [Мо-ов алгоритам](http://codeforces.com/blog/entry/7383) као потенцијално решење. Врло једноставно можемо одржавати за свако $i, 1 \leq i \leq V$ број $C_i$ - колико пута се вредност $i$ јавља у тренутном прозору и такође за колико различитих вредности $i$ важи да су једнаке $C_i, B_i$, нека је тај број $Z$. У $1$-димензионој варијанти временска сложеност би била $O(N \sqrt{N} + Q)$.

## Генерализација у више димензија и измене

Посматрајмо 5-димензиони простор, где 4 димензије одговарају позицијама $(x_1, y_1, x_2, y_2)$ прозора док последња димензија одговара редном броју упита. Посматрајмо колико нам елементарних корака треба да од тачке $(x_1, y_1, x_2, y_2, t)$ дођемо до тачке $(x_1', y_1', x_2', y_2', t')$. Кроз просторне димензије се крећемо тако што повећавамо или смањујемо вредности $x_1, y_1, x_2, y_2$. Да бисмо једну од њих променили за тачно један, треба нам онолико времена колика је ширина прозора у другој димензији (толико вредности бива убачено тј. избачено). Кретање кроз време је једноставније, уколико је позиција прозора фиксна, само посматрамо да ли вредност која се мења у тренутку $t$ упада у прозор. Ако не упада, само је променимо у матрици а ако упада додатно ажурирамо вредности $C_i, Z$. Сада, изделимо цео овај простор на блокове, који у просторној димензији имају ширину $\frac{D}{N}$ а у временској $D$. Унутар једног блока могуће је доћи од било које до било које друге тачке у не више од $5D$ елементарних корака. Од једног блока до суседног блока могуће је доћи у $D$ елементарних корака. Најзад, распоредимо упите у блокове и решавамо упите из једног блока, па из неког од суседних блокова, и тако даље. Укупан број елементарних корака потребан да се реше сви упити је не већи од $DW + 5DQ$, где је $W = \frac{N^4Q}{(\frac{D}{N})^4 D} = \frac{N^8Q}{D^5}$ број блокова. Сада, нађимо најбољу величину блока. Ово се може урадити простим испробавањем различитих вредности $D$ али се добра процена може наћи математички. Нађимо извод израза $DW + 5DQ$ по $D$. Он износи $5Q - \frac{4N^8 Q}{D^5}$. Ако га изједначимо са нулом и решимо по $D$, добићемо вредност која минимизује време извршења. Резултат је $D \approx 0.956 N^\frac{8}{5}$, односно, за $N=840, D \approx 45600$. Пошто је $Q \leq 10000$ ово значи да не морамо да делимо у блокове по временској димензији, док у просторној делимо на блокове ширине $\approx 54$, најближи делилац броја $840$ је $56$. Временска сложеност решења је $O(Q N^\frac{8}{5})$.