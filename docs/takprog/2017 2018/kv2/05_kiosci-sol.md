Означимо са $(x_i, y_i)$ координате а са $v_i$ количину магле у $i$-том по реду отвореном киоску. Јасно је да је за сваки упит типа 2 са параметрима $(x, y)$ потребно израчунати суму $\sum_{i=1}^k (|x - x_i| + |y - y_i|)\cdot v_i$, где је $k$ тренутни број изграђених киоска. Директно рачунање суме за сваки упит доводи до решења сложености $O(n^2)$ што је довољно само за први подзадатак. Једно корисно (и, када се ради са Менхетн растојањима, врло стандардно) запажање је да се претходна сума **може независно посматрати по $x$ и $y$ координатама**; дакле, довољно је решити проблем рачунања суме  $\sum_{i=1}^k |x - x_i|\cdot v_i$,  применити исти алгоритам за $y$ координате и сабрати две добијене вредности на крају.

Уколико је $m$ довољно мала вредност, можемо користити помоћне низове $vx[]$ и $vy[]$ дужине $m$ где је $vx[a] =$ сума вредности $v_i$ за све изграђене киоске чија је $x$-координата једнака $a$ (аналогно и за низ $vy[]$). Приликом додавања новог киоска $(x_i, y_i, v_i)$, aжурирамо информације са $vx[x_i] \leftarrow vx[x_i] + v_i$ док приликом упита типа 2 $(x, y)$, тражена сума се своди на $\sum_{i=1}^m |x - i|\cdot vx[i]$. Овим смо добили алгоритам сложености $O(nm)$ који користи $O(m)$ меморије, што решава други подзадатак. 

У трећем подзадатку, након учитавања свих упита типа 1, нема више промена; посматрано по једној координати, задатак постаје еквивалентан "тежинској" верзији задатка Продавнице са првог круга квалификација (видети одговарајуће решење). Сортирањем упита типа 1 на почетку и користећи бинарну претрагу за упите типа 2 добиијамо решење сложености $O(n \log n)$.

Мотивисани решењем другог подзадатка, нека је $A[i]$ сума вредности $v$ за све киоске са $x$-координатом $i$, а нека је $B[i] = i \cdot A[i]$ (на почетку су оба низа попуњена нулама). Тражена сума (за упит $(x,y)$) се може трансформисати као

$$
\sum_{i=1}^k |x - x_i|\cdot v_i = \sum_{i=1}^m |x - i|\cdot A[i] = \sum_{1 \leq i \leq x} (x \cdot A[i] - B[i]) + \sum_{x < i \leq m} (B[i] - x \cdot A[i])
$$

$$
= 2x \cdot \sum_{1 \leq i \leq x} A[i] - 2 \cdot \sum_{1 \leq i \leq x} B[i] - (x \cdot totalA - totalB)
$$

где су $totalA$ и $totalB$, редом, суме свих елемената низова $A$ и $B$. Задатак се сада своди на следеће: приликом упита типа 1 $(x, y, v)$ треба ажурирати $A[x] \leftarrow A[x] + v$ и $B[x] \leftarrow B[x] + x \cdot v$ (као и $totalA$ и $totalB$), док приликом упита типа 2 $(x, y)$ треба израчунати суме $\sum_{1 \leq i \leq x} A[i]$ и $\sum_{1 \leq i \leq x} B[i]$ и убацити их у горњу формулу.

Међутим, ово је познати проблем који се најефикасније решава помоћу **Кумулативне табеле** или **Сегментног стабла** над низовима $A$ и $B$ (и, наравно, одговарајућим низовима за $y$-координате). Користећи ове структуре, добијамо сложеност $O(\log n)$ по упиту, тј. укупно $O(n \log n)$. Како ове структуре захтевају $O(m)$ меморије, праволинијска имплементација је довољна за прва 4 подзадатка. Да бисмо очували ову сложеност, финални позадатак је потребно радити '*offline*' уз пар трикова: учитати све координате и компресовати их на сегмент $[1,n]$ (нпр. сортирањем) уз одговарајуће мапирање - тиме се меморијска сложеност своди на $O(n)$. Меморијско ограничење је дозвољавало и да се задатак ради '*online*' користећи **Имплицитно сегментно стабло** - у том случају је временска и меморијска сложеност алгоритма $O(n \log m)$.
