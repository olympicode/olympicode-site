## Подзадатак када је $N, Q \leq 4000$

Можемо да одржавамо тренутни редослед насеља у низу. Операција замене се своди на једноставно замењивање два члана низа, док је одговарање на други тип догађаја мало компликованије. Можемо да пустимо **DFS** или **BFS** алгоритам из насеља $x$ како бисмо нашли удаљености од истог до сваког другог насеља. Након што смо нашли и сачували удаљености можемо да прођемо кроз део низа од $l$ до $r$ и нађемо највећу удаљеност. Временска сложеност овог решења је $O(QN)$.

## Подзадатак када је свако насеље суседно са највише два друга насеља

У овом случају насеља заправо формирају ланац и можемо да их поређамо у низ почевши од једног краја. За свако насеље запамтимо његову позицију у овом низу. Када тражимо највећу удаљеност од насеља $x$ до скупа насеља од $l$ до $r$ битна су нам само два насеља из тог скупа, насеље са најмањом и насеље са највећом позицијом (удаљеношћу од краја ланца). Ово можемо ефикасно да имплементирамо коришћењем неке структуре података која подржава упите за минимум/максимум на поднизу и промену члана низа. На пример можемо да користимо **сегментно стабло** и добијемо временску сложеност $О(N + QlogN)$.

## Подзадатак када је у сваком догађају $x = 1$ и $p_a, p_b \neq 1$

Како се у сваком питању тражи највећа удаљеност од насеља 1, на почетку пустимо **DFS** или **BFS** алгоритам из овог насеља и нађимо узаљености до сваког другог насеља. Чувајмо низ где је $i$-ти члан удаљеност од насеља 1 до насеља $p_i$. Питања се своде на тражење максимума на поднизу овог низа. Можемо и овде да искористимо **сегментно стабло** за ефикасне операције тражења максимума и промене у низу након догађаја првог типа. Временса сложеност је $O(N + QlogN)$.

## Решење без додатних ограничења

Слично као код решења за ланац за свако питање можемо да нађемо два насеља од којих ће увек једно бити најдаље без обзира на одабир насеља $x$. За ово решење треба нам мало теорије везане за стабла. Пречник стабла је највећа удаљеност између два чвора, а крајеви пречника су чворови који су на тој највећој удаљености. Корисна особина пречника стабла је то да је најдаљи чвор од произвољног чвора увек један од крајева пречника. Насеља која ћемо тражити су крајеви пречника подстабла које обухвата насеља $p_l, p_{l+1}, \dots, p_r$. И у овом решењу можемо користити сегментно стабло. За сваки сегмент чувајмо крајеве пречника, а пречник за два спојена сегмента тражимо тако што нађемо највећу удаљеност између 2 од 4 чвора који су крајеви пречника левог и десног сегмента. Остаје још да нађемо начин како ефикасно да нађемо удаљеност између два чвора. Можемо да поставимо чвор 1 као корен и израчунамо дубину сваког чвора $depth(x)$. Дистанца између два чвора $x$ и $y$ је $depth(x) + depth(y) - 2 depth(LCA(x, y))$, где је $LCA(x, y)$ најмањи заједнички предак чворова $x$ и $y$, односно чвор на ком се пут од $x$ до корена и пут од $y$ до корена срећу. Најмањи заједнички предак може се наћи у $O(logN)$ са **binary lifting** техником или у $О(1)$ са **sparse табелом** над Ојлеровим путем. Препроцесирање за обе опције је временске и меморијеске сложености $О(NlogN)$, а цело решење верменске сложености $O(NlogN + Q log^2 N)$ или $O(NlogN + QlogN)$ у зависности од одабране технике.
