## Решење за $k\leq1000$:
У случају $k\leq1000$ је довољно да се примети да ће између свака два судара бити највише $\{ m,n \}$  корака: у најгорем случају се Дрејко кретао од једног до другог краја матрице. Стога је симулација овог кретања прихватљиво решење чија је временска сложеност $O(k \cdot \{ m,n \} )$

Иако иза овог решења не постоји никаква права “идеја”, оно се показује изузетно тешким за исправну имплементацију. Конкретно, у једном приступу бисмо морали да разматрамо све могуће “режиме” кретања и, у зависности од тога да ли се Дрејко креће ка северу, југу, западу или истоку, имали бисмо разне случајеве. Појединачно они нису нарочито тешки, али проблем настаје уколико желимо да уведемо измене у логику, након чега морају аналогне (али не идентичне!) измене да се уведу у свим случајевима – тада настају врло непријатне грешке. Зато ћемо представити опис неких уобичајених техника које сва четири случаја спајају у један општи.

Нумеришимо режиме кретања бројевима $0, 1, 2, 3$  ($0$ – јужно, $1$ – источно, $2$ – северно, $3$ – западно). Тада је очигледно да се након сваког судара нумерација нашег режима увећа за $1$ (по модулу $4$: прелаз $3 \rightarrow 0$).

Режим кретања може да се опише тиме што у сваком режиму постоји заједничко понашање: направићемо корак $(x,y) \rightarrow (x+dx,y+dy)$ уколико је поље $(x+dx,y+dy)$ слободно; у супротном, мења се режим кретања јер је дошло до судара. Очигледно $(dx,dy)$ варира у зависности од режима кретања, те су нам неопходна два низа $dx$ и $dy$.

## Решење за $k\leq10^7$: 
Очигледно је да у овом случају тражимо решење које је линеарно по променљивој $k$. Дакле, уколико бисмо итерирали “по сударима”, између свака два судара желимо да имамо константан број операција које нам говоре до ког поља стижемо. Ово наговештава неко препроцесирање.

Приметимо да је једно Дрејково стање описано положајем и актуелним режимом кретања и да јединствено одређује стање након следећег судара са зидом. Конкретно, имамо неколико случајева:

-   очигледно је немогуће да се Дрејко нађе „у зиду“, па нас такви случајеви не занимају;
-   ако је Дрејко одмах поред неког зида и уколико је усмерен ка њему, стање ће одговарати само промењеном режиму кретања;  
-   у супротном, судар (тј. стање након наредног судара) до ког нас води тренутно кретање одговара судару до ког нас води поље на ком ћемо се налазити у следећем кораку.
- 
Последња чињеница је најважнија и поприлично усложњава решење. Дакле, неопходно је одредити за сваки пар режим,положај наредно стање. Ово очигледно може да се представи помоћу три низа са по три координате (координате су режим, $x$ и $y$), али како их израчунати? Рекурентна веза је постављена, одакле почети?

Приметимо да нам при израчунавању параметара наредног стања при фиксираном режиму уопште не утичу резултати из других режима. Дакле, одговоре за “северно”, “јужно”, “источно” и “западно” можемо да рачунамо потпуно независно. Из дефиниције режима кретања долазимо до закључака:

-   наредно стање уколико је режим кретања “јужно” ће прво бити израчунато у смеру југ–север;    
-   наредно стање уколико је режим кретања “северно” ће прво бити израчунато у смеру север–југ;
-   наредно стање уколико је режим кретања “источно” ће прво бити израчунато у смеру исток–запад;   
-   наредно стање уколико је режим кретања “јужно” ће прво бити израчунато у смеру запад–исток.

Дакле, можемо да попуњавамо стања у четири матрице (у неким имплементацијама можда и осам матрица – Дрејкова усмереност и врста координате на коју се односи)

Сада је уопштавање свих ових случајева нешто компликованије и једна процедура која би генерисала наредна стања при фиксном режиму би била имала нешто неразумљивији облик. Зато се предлаже да се у овом решењу “жртвује” модуларност кода зарад једноставности.

Дакле, за решење у ком се најпре препроцесирају “ланци” стања у $O(nm)$, након чега се у $O(k)$ размотре сви судари.

## Главно решење:
Уведимо појам стања као у претходном подзадатку. Приметимо да их нема више од $O(4mn)$: за сваки положај постоје четири режима кретања. Уколико је дат било који довољно дугачак низ стања (дужине бар $4mn+1$), у њему ће се неко стање сигурно наћи бар два пута (Дирихлеов принцип). Међутим, пошто је наредно стање увек унапред одређено, закључујемо да је низ стања периодичан.

Ова чињеница није толико необична, али нам помаже да дођемо до решења чија временска сложеност неће зависити од $k$. Довољно је да се симулира кретање све док не стигнемо до $k$-тог судара или не наиђемо на поље које смо већ обишли (водити рачуна о оба случаја!).

У поменутом другом случају, за симулацију може да се користи решење претходног подзадатка, али није нужно због природе проблема – довољно је користити просту симулацију из првог подзадатка (поменутих $O(4mn)$ стања нису само она када се мења режим кретања!).

Након одређивања периода и редног броја судара који је први у циклусу, уз мало модуларне аритметике се једноставно одреди завршно стање. Конкретно, уколико је редни број првог судара у циклусу $p$, дужина циклуса $T$, а тражимо $k$-ти положај, тада је редни број судара који нас занима у овом циклусу $k-p \mod T$. Покушајмо да оправдамо: првих $p$ корака у симулацији су пре циклуса, стога смо у току цикличног обиласка имали $k-p$ корака; нулто и $T$-то стање у циклусу су идентични, те је довољно посматрати модул $T$.

Дакле, решење првог подзадатка је довољно проширити увођењем помоћних матрица које нам говоре када смо први пут дошли до неког стања. Водећи се идејом компактности записа, предлаже се да се и даље користи једна једина матрица, али ће имати три димензије – додатна координата је индекс смера! Пре него што се први пут доспе у неко стање, време неопходно да се до њега дође се најпре подеси на неко немогуће (на пример, $-1$). При обиласку неког стања се најпре испита да ли је реч о неком раније обиђеном стању (тако што се види да ли је у том пољу поменута „немогућа“ вредност), након чега није тешко одредити период.

Опет, неопходно је обратити пажњу на случај када до траженог судара дође пре уласка у циклус!
