# Два стабла

Аутор: Тадија Шебез
Текст и тест примери: Тадија Шебез
Анализа решења: Тадија Шебез
Тестирање: Алекса Милисављевић

За $P=0$ сви упити су унапред познати па их можемо решавати у произвољном редоследу. Када је $P=1$ морамо да одговоримо на $i$-ти упит да бисмо сазнали $i+1$-ви упит, па задатак морамо да решавамо **online**, односно да на упите одговарамо редом којим су задати.

### Решење када је $N, Q \leq 1000$

Искористимо **DFS** алгоритам да нађемо све чворове на једном и на другом путу и затим пребројмо колико чворова се налази на оба пута. Временска сложеност је $O(QN)$.

### Решење када су оба стабла ланци

Уз помоћ **DFS** алгоритма можемо да поређамо чворове оба стабла у два низа. Нека су то низови $S$ и $T$. У овом случају се упити своде на питања за поднизове. Посматрајмо упит за подниз $L1 \dots R1$ низа $S$ и подниз $L2 \dots R2$ низа $T$. Ако бисмо у низу $T$ означили са 1 позицију $i$ ако се $T_i$ налази на поднизу $L1 \dots R1$ низа $S$, и са 0 у супротном, решење за упит би било збир ознака на поднизу $L2 \dots R2$ низа $T$. 

За подзадатак када је $N, Q \leq 3 \times 10^4$, можемо да одржавамо ознаке у **Фенвиковом стаблу** и упите решавамо **offline** помоћу **Мо-овог алгоритма**. Упите сортирамо по пару $(\lfloor frac{L1}{\sqrt{N}} \rfloor, R1)$ и решавамо их у том редоследу. Када решимо упит са поднизом $L1_{i-1} \dots R1_{i-1}$ леву границу померамо до $L1_i$, а десну до $R1_i$, мењајући $|L1_i-L1_{i-1}|+|R1_i-R1_{i-1}|$ ознака у низу $T$. На овај начин имаћемо $O(N \sqrt{N})$ промена и за сваку промену нам треба $O(logN)$ времена за измену у **Фенвиковом стаблу**, па је временска сложеност овог решења $O(N \sqrt{N} logN)$.


Када је $N, Q \leq 2 \times 10^5$ и $P=0$, решење је слично као претходно, али потребна нам је једна кључна опсервација: Решење за упит $L1, R1, L2, R2$ једнако је решење за $1, R1, L2, R2$ минус решење за $1, L1-1, L2, R2$. На овај начин можемо да раставимо упите на по два упита за које је подниз низа $S$ заправо префикс истог. Ако упите сортирамо по десној граници подниза низа $S$, укупан број измена у **Фенвиковом стаблу** ће бити највише $N$. Временска сложеност овог решења је $O(NlogN)$.


Када је $P=1$, можемо да применимо исто решење, али уместо **Фенвиковог стабла** треба да искористимо **презистентно сегментно стабло** како бисмо могли да сачувамо по верзију сегментног стабла за сваки од $N$ префикса низа $S$, и касније их користили да одговарамо на упите у задатом редоследу.

### Решење када је једно стабло ланац

У овом случају ланац можемо да претворимо у низ $S$ и на њему радимо **Мо-ов алгоритам** или да раставимо упите као у прошлом решењу. Део решења који се мења је то да нам више нису потребни упити за збир на поднизу већ за збир на путу у стаблу. Пут од $A$ до $B$ у стаблу можемо да раставимо на пут од корена до $A$, плус пут од корена до $B$, минус пут од корена до $\text{LCA}(A,B)$, минус пут од корена до $\text{parent}(\text{LCA}(A,B))$. Треба још да нађемо начин да добијемо збир ознака свих чворова на путу од корена до неког чвора. Урадимо **Ојлеров обилазак** стабла и сместимо чворове у низ тим редом како смо их посетили у **DFS**-у. На овај начин ће свако подстабло да чини један подниз. Током **DFS**-а можемо да запамтимо и границе поднизова за свако подстабло. Над низом који смо овако добили можемо да направимо **Фенвиково стабло** које подржава упите повећавања и смањивања вредности свих чланова неког подниза, и упите који враћају вредност неког чвора. Ако користимо **Мо-ов алгоритам** са овом структуром добијамо сложеност $O(N \sqrt{N} logN)$, што пролази подзадатак када је $N, Q \leq 3 \times 10^4$, а ако раставимо поднизове низа $S$ као у претходном подзадатку, добијамо решење у временској сложености $O(NlogN)$ што пролази и подзадатак када је $N, Q \leq 2 \times 10^5$.

### Reшење када је $N, Q \leq 3 \times 10^4$

Решење за овај подзадатак је да на једно стабло применимо **Мо-ов алгоритам**, а на друго стабло исту структуру података као у претходном решењу. **Мо-ов алгоритам** на стаблу заправо примењујемо на **Ојлеровом обиласку**. Направимо од стабла низ дужине $2N$ тако што ставимо чвор у низ када улазимо и када излазимо из чвора. Пут од $A$ до $B$, где је прво појављивање чвора $A$ пре првог појављивања чвора $B$, мапирамо на подниз од другог појављивања чвора $A$ до првог појављивања чвора $B$, осим ако је $A$ предак чвора $B$, када овај пут мапирамо на подниз од првог појављивања $A$ до првог појављивања $B$. У првом случају се сви чворови на путу осим $\text{LCA}(A, B)$ пјављују тачно једном, а остали чворови 0 или 2 пута. У другом случају сви чворови на путу од $A$ до $B$ се пајављују тачно једном, а остали чворови 0 или 2 пута. Када сортирамо упите, у структури за друго стабло одржавамо све чворове који се појављују тачно једном и пре решавања упита убацимо и чвор $\text{LCA}(A, B)$ ако већ није убачен. Временска сложеност овог алгоритма је $O(N \sqrt{N} logN)$.

### Reшење када је $P=0$

Као што смо раставили пут у другом стаблу, тако можемо да раставимо и пут у првом стаблу. И у овом решењу на исти начин радимо са другим стаблом, а за прво стабло упите растављамо на по 4 упита за путеве од корена до неког чвора. Упите ћемо решити **offline**, **DFS** алгоритмом. Када уђемо у неки чвор додамо га у структури за друго стабло, затим решимо све упите за путеве од корена до тренутног чвора и на крају када изађемо из чвора избацујемо тренутни чвор из структуре за друго стабло. Временска сложеност овог решења је $O(NlogN)$.

### Решење за 100 поена

**Online** решење је слично као и **offline** решење, само што користимо **перзистентно сегментно стабло** уместо **Фенвиковог стабла** као структуру за друго стабло. На тај начин можемо да запамтимо верзије структуре каква је била након уласка у сваки чвор, и уз помоћ тога можемо редом да одговарамо на упите. Временска и меморијска сложеност овог решења је $O(NlogN)$.
