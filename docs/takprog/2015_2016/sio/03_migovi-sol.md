Формулација задатка је прилично једноставна а јасно је и да се ради са стандардним **Менхетн-растојањем<sup>1</sup>** између тачака које поседује неколико корисних особина које ћемо и експлоатисати. Користићемо термине $U$-миг, $R$-миг, $D$-миг и $L$-миг за мигове чији су смерови кретања, редом, горе, десно, доле и лево. Такође, за пар мигова ћемо рећи да чине $ort$--пар (ортогонални пар) уколико су им смерови кретања нормални један на други, а иначе они чине $par$--пар (паралелни пар); интуитивно је јасно да ће нам већи проблем правити $ort$--парови. Да бисмо дошли до оптималног алогритма најлакше (и најприродније) је решавати подзадатке редом.

## Подзадатак $1$
На основу ограничења, јасно је да је овде довољан тривијалан алогоритам који одређује минимална растојања између свака два мига (посебно) у сложености $O(N^2)$. Ипак, сама имплементација захтева анализу неколико случајева а један од паметнијих начина је следећи: нека су $i(x_i, y_i)$ и $j(x_j, y_j)$ два мига; није тешко уочити да је минимално растојање између $i$ и $j$ управо њихово менхетн-растојање  $|x_i -x_j| + |y_i - y_j|$ осим у случају када они чине $par$--пар и крећу се један ка другом или $ort$--пар и оба иду ка пресечној тачки (тада су тражена растојања мања). За последња два случаја треба одузети одговарајући "вишак" а ту технику ћемо користити и у наредним подзадацима.

## Подзадатак $2$
Како сви мигови иду нагоре једнаким брзинама, њихова међусобна растојања остају иста па можемо замислити да се не крећу. Проблем се своди на (познат) проблем одређивања суме свих менхетн-растојања (по паровима) датих $N$ тачака. Како је менхетн растојање независно по координатама, тј. $\sum_{1 \leq i < j \leq n} (|x_i - x_j| + |y_i - y_j|) = \sum_{1 \leq i < j \leq n} |x_i - x_j| + \sum_{1 \leq i < j \leq n} |y_i - y_j|$, проблем се своди на израчунавање израза $F(a) = \sum_{1 \leq i < j \leq n} |a_i - a_j|$ за дати низ $a$. Сума не зависи од позиција елемената у низу већ само од њихових вредности па сортирањем низа $a$ ($a_1 \leq a_2 \leq \ldots \leq a_N$) "губимо" апсолутне вредности и након мало трансформација добијамо $F(a) =  \sum_{1 \leq i < j \leq n} (a_j - a_i) = \sum_{j = 1}^N (j\cdot a_j - p_{j-1})$ где је $p$ низ префиксних сума тј. $p_i = a_1 + a_2 + \ldots + a_i$.

Израз за $F(a)$ смо после сортирања могли трансформисати и на други начин: за свако $k$, вредност $a_k$ се у суми $\sum_{1 \leq i < j \leq n} (a_j - a_i)$ јавља тачно $k-1$ пута са предзнаком "$+$" и тачно $N - k$ пута са предзнаком "$-$" (толико има мањих/већих вредности од $a_k$) па добијамо да је $F(a) = \sum_{k=1}^N (k - 1 - (N - k)) \cdot a_k = \sum_{k=1}^N (2k - N - 1)\cdot a_k$. У оба случаја је јасно да се сума може израчунати у сложености $O(N)$ па се рачунање израза $F(x) + F(y)$ може одрадити у сложености $O(N \log N)$ (због сортирања) што је довољно за овај подзадатак.

## Подзадатак $3$
У овом подзадатку сваки пар мигова чини $par$--пар при чему се $y$ координате мигова не мењају. Приметимо да је минимално растојање између мигова $i$ и $j$ једнако $|y_i - y_j|$ уколико иду "један другом у сусрет" (јер ће у неком тренутку бити $|x_i - x_j| = 0$), односно $|x_i - x_j| + |y_i - y_j|$ у осталим случајевима (тада се вредност $|x_i - x_j|$ неће смањивати).  Дакле, и даље можемо посматрати одвојено $x$ и $y$ координате а један од најлакших начина за решавање овог подзадатка је израчунати тражена растојања под претпоставком да се мигови не померају (у сложености $O(N \log N)$ као у претходном задатку) а затим од добијеног резултата одузети "вишак", тј. одузети по $|x_i - x_j|$ за свака два мига $i$ и $j$ који иду један другом у сусрет.

Уколико неопадајуће сортирамо $x$ координате мигова, проблем се своди на ефикасно рачунање суме свих $|x_j - x_i|$ за свако $i < j$ где је миг $i$ $R$-миг а миг $j$ $L$-миг. Очекивано, ово се може урадити у сложености $O(N)$: довољно је кретати се с лева на десно и у сваком тренутку памтити вредности $sumR$ и $numR$ који, редом, представљају суму $x$--координата и број свих претходних $R$-мигова. Уколико је $i$-ти миг $R$-миг, одрадимо $update$ тренутних вредности а у супротном нашој траженој суми треба додати вредност $numR \cdot x_i - sumR$ (тренутни миг ће "поништити" растојања за свих $numR$ $R$-мигова са његове леве стране). Дакле, укупна сложеност за овај подзадатак је $O(N\log N)$.

## Подзадатак $4$
Овде настаје прави проблем јер је због $ort$--парова немогуће посматрати независно $x$ и $y$ координате. Заиста, уколико мигови $i$ и $j$ чине $ort$--пар и оба иду ка пресечној тачки (назовимо овакве парове *лоши*), тада ће они (први пут) достићи минимално растојање када миг који је ближи тачки пресека дође у исту -- тада је растојање $||x_i - x_j| - |y_i - y_j||$ и не може се лепо "разложити" на координате. 

<figure style="text-align:center">
  <img src="Migovi_Image_Dist_And_Triangle.png" alt="Растојање и подела области" width="700">
  <figcaption> *Слика $1$:  $a)$ минимално растојање код лошег пара; $b)$ Подела горњег-десног квадратна за $R$-мига $(x_i, y_i)$ на два бесконачна троугла: "горњи троугао" (област $I$) ограничен правама $x = x_i$ и $y = x + (y_i - x_i)$ и "доњи троугао" (област $II$) ограничен правама $y = y_i$ и $y = x + (y_i - x_i)$.* </figcaption>
</figure> 

Претходни израз можемо трансформисати у $|x_i - x_j| + |y_i - y_j| - 2 \cdot \min\{|x_i - x_j|, |y_i - y_j|\}$ са мотивацијом да применимо метод "одузимања вишка": уколико саберемо сва почетна међусобна растојања (подзадатака $2$) а затим одузмемо вишак за $par$--парове (Подзадатак $3$, посебно за групу $L/R$-мигова и групу $U/D$-мигова) остаје само да за сваки лош пар мигова $i$ и $j$ одузмемо вредност $2 \cdot \min\{|x_i - x_j|, |y_i - y_j|\}$. Лоше парове можемо, зависно од смерова мигова, поделити у $4$ дисјунктне групе ($RD$, $DL$, $LU$ и $UR$) које се (очекивано) решавају на симетричан начин. Због тога описујемо решење само за $RD$ групу, тј. проблем се своди на ефикасно рачунање суме
$$2\sum_{\substack{i \in R, \enspace j \in D \\ (i,j) \text{ је лош пар}}} \min\{|x_i - x_j|, |y_i - y_j|\}.$$ Користећи чињеницу да су за дати $R$-миг $i$ сви мигови који чине лош пар са њим управо $D$-мигови који су "горе-десно" од њега (тј. $D$-мигови $j$ за које важи $x_i \leq x_j$ и $y_i \leq y_j$) проблем се (после избацивања фактора $2$) додатно своди на рачунање израза
$$\sum_{i \in R} \sum_{\substack{j \in D, \\ x_i \leq x_j, \; y_i \leq x_j}} \min\{x_j - x_i, y_j - y_i\}$$ За избацивање незгодног минимума, уведимо следеће ознаке на основу Слике $1$: за дати $R$-миг $i$ нека су $T_x(i)$ и $T_y(i)$, редом, скупови свих $D$-мигова који се налазе "горњем троуглу" (област $I$), односно "доњем троуглу" (област $II$) мига $i$.  Није тешко видети да ако $j \in T_x(i)$ тада $x_j - x_i \leq y_j - y_i$ и да из $j \in T_y(i)$ следи $y_j - y_i \leq x_j - x_i$. Сада претходну суму можемо написати као $$\sum_{i \in R}\sum_{j \in T_x(i)} (x_j - x_i) + \sum_{i \in R}\sum_{j \in T_y(i)} (y_j - y_i).$$ Због симетрије, концентрисаћемо се на леву суму претходног израза. За почетак, можемо се обезбедити да унутрашња сума што мање зависи од $i$: нека је $n_i = |T_x(i)|$ (број $D$-мигова у троуглу) и $s_i = \sum_{j \in T_x(i)} x_j$ (сума $x$ коодината $D$-мигова из троугла). Коначно, претходна десна сума се своди на $$\sum_{i \in R} (s_i - n_i \cdot x_i).$$ У овом тренутку (а искусни такмичар то може схватити много раније) проблем можемо коначно свести на ефикасно одговарање на упите следећег типа: за дату тачку $(x_i, y_i)$, одредити број тачака (као и збир њихових $x$ координата) које леже у "доњем троуглу" одређеном тачком $(x_i, y_i)$. Стандардни покушај је сортирати $R$ и $D$-мигове заједно по неком параметру а затим их редом обилазити ($sweep$) и приликом наиласка на $D$-мига вршити убацивање у неку структуру а приликом наиласка на $R$-мига вршити упит над том структуром. Најприроднији приступ -- $sweep$ по једној координати а одређивање позиција у структури по другој, овде не пролази јер троуглови нису само одређени правама паралелним $x$ и $y$-осама већ и правама параленим правој $y = x$. **И управо је кључни део задатка радити $sweep$ по правама паралелних правој $y = x$ у смеру "горе-лево" $\rightarrow$ "доле-десно".** 

Прецизније, прво сортирамо мигове неопадајуће по вредности $x_i - y_i$; у том редоследу ћемо их обилазити. Додатно за сваког мига $i$ израчунамо $pos_i$ -- позиција у низу на којој би се миг нашао уколико бисмо их све сортирали по $x$ координатама. Приликом обиласка у горе поменутом редоследу, ми наилазимо на мигове и, зависно од типа мига, радимо следеће (види Слику $2$):

* $D$-миг $j$: убацујемо миг $j$ у помоћни низ $A$ на позицији $pos_j$.
* $R$-миг $i$: рачунамо број мигова и суму $x$ координата свих мигова који се налазе у сегменту $[pos_i, N]$ у низу $A$. Чињеница да је неки миг $j$ већ у низу $A$ и да је $pos_j > pos_i$ је еквивалентна са $x_j - y_j \leq x_i - y_i$ и $x_j \geq x_i$ што је услов да $j$ припада "горњем троуглу", тј. $j \in T_x(i)$.



Због природе упита, јасно је да уместо низа $A$ можемо користити **Сегментно стабло<sup>2</sup>** или **Кумулативну табелу<sup>3</sup>** и постићи сложеност $O(\log N)$ за сваки од поменута два упита/догађаја, па горе поменуту суму $\sum_{i \in R} (s_i - n_i \cdot x_i)$ можемо израчунати у сложености $O(N \log N)$.  Аналогно рачунамо суму и за "доње троуглове" -- тада радимо обрнути обилазак ("доле-десно" $\rightarrow$ "горе-лево") а низ $pos$ се односи на $y$ координате. Све ово радимо $4$ пута (за сваку групу лоших парова) па је укупна сложеност алгоритма $O(N \log N)$.

## Детаљи имплементације

Из описа оптималног решења види се да је потребно одрадити $8$ сличних $sweep$-ова вршећи одговарајуће упите (по два обиласка за сваку од $4$ групе). Овде никако не треба радити са $8$ различитих области од интереса ("троуглова") и $8$ пута дужим кодом, већ сваку групу лоших парова свести на $RD$ групу ротацијом равни за $90^\circ$ и позивом исте функције. Додатно, два поменута $sweep$-а у оквиру исте групе је могуће имплементирати позивом исте функције уколико се структури као параметар преноси и информација да ли се ради о $x$ или $y$ оси. Такође, потребно је прецизније у коду дефинисати "горњи и доњи троугао", тј. одредити коме од њих припадају мигови на дијагонали да се не би рачунали два пута. Напоменимо и то да смо $sweep$ могли радити по некој од оса а низ $pos$ индексирати на основу разлика $x_i - y_i$.

